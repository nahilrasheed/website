---
import PageLayout from '@/layouts/BaseLayout.astro'
import { getVaultTree } from '@/utils/vault'
import VaultTree from '@/components/vault/VaultTree.astro'

const meta = {
  title: 'Vault',
  description: 'Knowledge Base'
}

const tree = await getVaultTree()
---

<PageLayout {meta} wide>
  <div class='mt-4 max-w-[90rem] mx-auto px-4 lg:px-0'>
    <h1 class='text-3xl font-bold mb-4 tracking-tight text-foreground'>Vault</h1>
    <p class='text-muted-foreground mb-8 text-lg'>Welcome to my digital garden. Explore the notes below.</p>

    <div class='grid gap-4 sm:grid-cols-2 lg:grid-cols-3 items-start'>
      {tree.map((node) => (
        node.children.length > 0 ? (
          <details class='group relative border rounded-xl bg-card/60 text-card-foreground shadow-sm transition-all hover:bg-card/80 hover:z-30 open:z-50 open:bg-card open:rounded-b-none'>
            <summary class='flex items-center gap-2 p-4 cursor-pointer list-none transition-colors select-none'>
               <svg 
                 xmlns='http://www.w3.org/2000/svg' 
                 width='18' height='18' viewBox='0 0 24 24' 
                 fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' 
                 class='shrink-0 transition-transform duration-200 group-open:rotate-90 text-muted-foreground'
               >
                  <path d='m9 18 6-6-6-6'/>
               </svg>
               {node.slug ? (
                   <a href={`/vault/${node.slug}`} class='font-semibold text-lg decoration-dotted underline underline-offset-4 hover:decoration-solid hover:text-primary flex-1 break-words'>
                      {node.title}
                   </a>
               ) : (
                   <span class='font-semibold text-lg flex-1 break-words'>{node.title}</span>
               )}
            </summary>
            <div class='absolute top-full left-[-1px] right-[-1px] px-4 pb-4 pt-2 border-x border-b border-border bg-card rounded-b-xl shadow-xl'>
                <ul class='pt-2 space-y-0.5'>
                    {node.children.map((child) => (
                       <VaultTree node={child} />
                    ))}
                </ul>
            </div>
          </details>
        ) : (
           <a href={node.slug ? `/vault/${node.slug}` : '#'} class='block p-4 relative border rounded-xl bg-card/60 text-card-foreground shadow-sm transition-all hover:bg-card/80 hover:z-30'>
              <span class='font-semibold text-lg pl-6 block break-words'>
                  {node.title}
              </span>
           </a>
        )
      ))}
    </div>
  </div>
</PageLayout>
