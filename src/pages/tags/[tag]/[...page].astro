---
import type { GetStaticPaths, Page } from 'astro'
import type { CollectionEntry } from 'astro:content'

import { Paginator, PostPreview } from '@/components/pages'
import { getBlogCollection, getUniqueTags, sortMDByDate } from '@/utils/blog'
import { Button } from '@/components/user'
import PageLayout from '@/layouts/BaseLayout.astro'
import { getEnrichedVaultCollection, getUniqueVaultTags } from '@/utils/vault'

export const prerender = true

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const allPosts = await getBlogCollection()
  const allPostsByDate = sortMDByDate(allPosts)
  const allVault = await getEnrichedVaultCollection()
  
  // Get unique tags from both collections
  const blogTags = getUniqueTags(allPostsByDate)
  const vaultTags = await getUniqueVaultTags()
  const uniqueTags = [...new Set([...blogTags, ...vaultTags])]

  return uniqueTags.flatMap((tag) => {
    // Filter blog posts and vault entries by tag
    const filterPosts = allPostsByDate.filter((post) => 
      (post.data.tags ?? []).includes(tag)
    )
    const filterVault = allVault.filter((entry) => 
      (entry.data.tags ?? []).map((t: string) => t.toLowerCase()).includes(tag.toLowerCase())
    )
    
    // Combine both collections
    const combined = [...filterPosts, ...filterVault]
    
    return paginate(combined, {
      pageSize: 20,
      params: { tag }
    })
  })
}

interface Props {
  page: Page<CollectionEntry<'blog'> | CollectionEntry<'vault'>>
}

const { page } = Astro.props

// Reconstruct full tag from URL path (handles tags with slashes like "cybersec/tools")
// Extract tag from the URL path, removing /tags/ prefix and any numeric page suffix
const pathSegments = Astro.url.pathname.split('/').filter(Boolean)
const tagStartIndex = pathSegments.indexOf('tags') + 1
const tagSegments = pathSegments.slice(tagStartIndex).filter(seg => !/^\d+$/.test(seg))
const displayTag = tagSegments.join('/')

const meta = {
  description: `View all posts and vault notes with the tag - ${displayTag}`,
  title: `Tag: ${displayTag}`
}

const paginationProps = {
  ...(page.url.prev && {
    prevUrl: {
      text: `← Previous Tags`,
      url: page.url.prev
    }
  }),
  ...(page.url.next && {
    nextUrl: {
      text: `Next Tags →`,
      url: page.url.next
    }
  })
}
---

<PageLayout {meta}>
  <Button title='Back' href='/tags' variant='back' />
  <main class='mt-6 lg:mt-10'>
    <div id='content-header' class='animate'>
      <h1 class='mb-6 flex items-end gap-x-2 text-3xl font-medium'>
        Tags:
        <span class='text-2xl'>#{displayTag}</span>
      </h1>
    </div>

    <section id='content' class='animate' aria-label='Content list'>
      <div class='grid grid-cols-1 md:grid-cols-2 gap-6'>
        <div>
          <ul class='flex flex-col gap-y-3 text-start'>
            {page.data.map((item, index) => {
              if (index >= Math.ceil(page.data.length / 2)) return null
              
              const isBlog = item.collection === 'blog'
              
              if (isBlog) {
                return <PostPreview post={item as any} detailed />
              }
            })}
            {page.data.map((item, index) => {
              if (index >= Math.ceil(page.data.length / 2)) return null
              
              const isVault = item.collection === 'vault'
              
              if (isVault) {
                const vaultEntry = item as any
                return (
                  <li class='mb-3 border-l border-muted-foreground/30 pl-4'>
                    <a 
                      href={`/vault/${vaultEntry.slug}`}
                      class='font-semibold text-foreground hover:text-primary transition-colors'
                    >
                      {vaultEntry.data.title}
                    </a>
                    {vaultEntry.data.description && (
                      <p class='text-sm text-muted-foreground mt-1'>
                        {vaultEntry.data.description}
                      </p>
                    )}
                  </li>
                )
              }
            })}
          </ul>
        </div>
        <div>
          <ul class='flex flex-col gap-y-3 text-start'>
            {page.data.map((item, index) => {
              if (index < Math.ceil(page.data.length / 2)) return null
              
              const isBlog = item.collection === 'blog'
              
              if (isBlog) {
                return <PostPreview post={item as any} detailed />
              }
            })}
            {page.data.map((item, index) => {
              if (index < Math.ceil(page.data.length / 2)) return null
              
              const isVault = item.collection === 'vault'
              
              if (isVault) {
                const vaultEntry = item as any
                return (
                  <li class='mb-3 border-l border-muted-foreground/30 pl-4'>
                    <a 
                      href={`/vault/${vaultEntry.slug}`}
                      class='font-semibold text-foreground hover:text-primary transition-colors'
                    >
                      {vaultEntry.data.title}
                    </a>
                    {vaultEntry.data.description && (
                      <p class='text-sm text-muted-foreground mt-1'>
                        {vaultEntry.data.description}
                      </p>
                    )}
                  </li>
                )
              }
            })}
          </ul>
        </div>
      </div>
      <Paginator {...paginationProps} />
    </section>
  </main>
</PageLayout>
