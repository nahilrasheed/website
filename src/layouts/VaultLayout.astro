---
import PageLayout from '@/layouts/BaseLayout.astro'
import { Button, FormattedDate, Icon } from 'astro-pure/user'
import type { SiteMeta } from 'astro-pure/types'
import VaultTree from '@/components/vault/VaultTree.astro'
import { ArticleBottom, BackToTop, Copyright, TOC } from 'astro-pure/components/pages'

interface Props {
  meta: SiteMeta
  back?: string
  headings?: any[]
  currentSlug?: string
  // Data props for standard layout features
  entry?: any
  remarkPluginFrontmatter?: any
  editPath?: string
  paginationProps?: any
}

const { meta, back = '/vault', headings, currentSlug, entry, remarkPluginFrontmatter, editPath, paginationProps } = Astro.props

const dateTimeOptions: Intl.DateTimeFormatOptions = {
  month: 'short'
}
---

<PageLayout {meta} wide>
  <div class='flex flex-col lg:flex-row gap-6 lg:gap-12 items-start relative mt-4 px-4 lg:px-0'>
    
    <!-- Left Sidebar: Vault Navigation (Desktop) -->
    <aside 
      class='animate lg:w-64 shrink-0 lg:sticky lg:top-24 lg:h-[calc(100vh-8rem)] overflow-y-auto hidden lg:block border-r border-border/40 pr-4 custom-scrollbar'
    >
    <VaultTree {currentSlug} title='Vault' class='pb-10 w-full' />
    </aside>

    <!-- Sidebar Shade -->
    <div
      id='sidebar-shade'
      class='fixed top-0 start-0 w-full h-full'
      style='display:none;background-color:#00000091;z-index:31'
    >
    </div>

    <!-- Middle: Content -->
    <main class='flex-1 min-w-0 w-full'>
       <article>
           <div id='content-header' class='animate'>
               <slot name='header' />
                {entry && (
                  <>
                    <h1 class='text-2xl font-bold sm:mb-2 sm:text-3xl tracking-tight text-foreground'>
                      {entry.data.title}
                    </h1>

                    <div class='flex flex-wrap gap-x-4 gap-y-2 text-xs leading-6 text-muted-foreground'>
                      {/* Article date */}
                      {entry.data.publishDate && (
                        <div class='flex items-center gap-1'>
                          <Icon name='calendar' class='size-5' />
                          <FormattedDate class='font-sans' date={entry.data.publishDate} dateTimeOptions={dateTimeOptions} />
                          {
                            entry.data.updatedDate && (
                              <div class='flex items-center gap-1'>
                                <span> / </span>
                                <span> Update <FormattedDate class='font-sans' date={entry.data.updatedDate} dateTimeOptions={dateTimeOptions} />
                                </span>
                              </div>
                            )
                          }
                        </div>
                      )}
                      
                      {/* Times read */}
                      {remarkPluginFrontmatter?.minutesRead && (
                        <div class='flex items-center gap-1'>
                          <Icon name='time' class='size-5' />
                          {remarkPluginFrontmatter.minutesRead}
                        </div>
                      )}

                      {/* Tags */}
                      {
                        !!entry.data.tags?.length && (
                          <span class='flex items-center gap-1'>
                            <Icon name='hashtag' class='size-5' />
                            {entry.data.tags.map((tag: string, i: number) => (
                              <div>
                                <a
                                  aria-label={`View more blogs with the tag ${tag}`}
                                  class='hover:underline hover:underline-offset-4'
                                  data-pagefind-filter='tag'
                                  href={`/tags/${tag}`}
                                >
                                  {tag}
                                </a>
                                {i < entry.data.tags.length - 1 && '/'}
                              </div>
                            ))}
                          </span>
                        )
                      }
                    </div>

                    <div class='mt-3 italic text-muted-foreground'>
                      {
                        entry.data.description && (
                          <blockquote class='text-sm text-muted-foreground'><q>{entry.data.description}</q></blockquote>
                        )
                      }
                    </div>

                    {/* Dividing line */}
                    <div class='mt-4 w-1/2 border-t max-md:mx-auto sm:mt-6 sm:w-1/3 '></div>
                  </>
                )}
           </div>
           
           <div id='content' class='animate mt-8 prose dark:prose-invert max-w-none'>
              <slot />
           </div>

           <div class='animate mt-12 pt-4 border-t'>
              <slot name='bottom' />
               {entry && (
                 <>
                    <Copyright data={entry.data} />
                    {editPath && (
                      <div class='flex justify-normal items-center mt-6 gap-x-12'>
                        <Button title='Edit on GitHub' href={editPath} class='text-sm text-muted-foreground hover:text-foreground'>
                        <svg slot='before' xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24'><g fill='none' fill-rule='evenodd'><path d='m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z'/><path fill='currentColor' d='M13.896 3.03a2 2 0 0 1 2.701-.117l.127.117l4.243 4.243a2 2 0 0 1 .117 2.7l-.117.128l-10.314 10.314a2 2 0 0 1-1.238.578L9.239 21H4.006a1.01 1.01 0 0 1-1.004-.9l-.006-.11v-5.233a2 2 0 0 1 .467-1.284l.12-.13L13.895 3.03ZM12.17 7.584l-7.174 7.174V19H9.24l7.174-7.174l-4.243-4.243Zm3.14-3.14L13.584 6.17l4.243 4.243l1.726-1.726z'/></g></svg>
                        Edit Page
                        </Button>
                      </div>
                    )}
                    
                    {paginationProps && (
                      <div class='mt-6'>
                          <ArticleBottom {...paginationProps} />
                      </div>
                    )}
                 </>
               )}
           </div>
       </article>
    </main>
    <!-- Right Sidebar: TOC -->
    <aside 
       class='animate lg:w-64 shrink-0 lg:sticky lg:top-24 hidden xl:block pl-4 z-40 fixed lg:order-2 lg:shrink-0 max-lg:border max-lg:px-4 max-lg:py-3 max-lg:bg-muted max-lg:rounded-xl right-0 top-20 h-[calc(100vh-7rem)] overflow-y-scroll max-lg:hidden'
       id='sidebar'
    >
        <!-- Mobile Vault Navigation (Inside Drawer) -->
        <details class="lg:hidden mb-4 group">
            <summary class="font-semibold py-2 flex items-center justify-between text-muted-foreground cursor-pointer list-none select-none hover:text-foreground">
                <span class='flex items-center gap-2'>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="3" rx="2"/><path d="M8 21h8"/><path d="M12 17v4"/></svg>
                    Navigation
                </span>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-200 group-open:rotate-180"><path d="m6 9 6 6 6-6"/></svg>
            </summary>
            <div class="mt-2 text-sm">
                <VaultTree {currentSlug} title='Vault' class='pb-10 w-full' />
                <div class="my-4 border-t border-border/50"></div>
            </div>
        </details>

        {!!headings?.length && (
            <div class='max-h-[calc(100vh-10rem)] overflow-y-auto custom-scrollbar pr-2 text-sm'>
                <TOC {headings} />
            </div>
        )}
    </aside>

  </div>

  <BackToTop header='content-header' content='content'>
    <button
      slot='other-icons'
      aria-label='Toggle sidebar'
      class='size-10 flex items-center justify-center rounded-full border-2 border-transparent bg-muted text-muted-foreground duration-300 hover:border-border/75 xl:hidden sm:size-12'
      id='sidebar-btn'
    >
      <Icon name='list' />
    </button>
  </BackToTop>
</PageLayout>

<script>
  // Toggle sidebar visibility on button click
  const sidebarButton = document.getElementById('sidebar-btn')
  const sidebar = document.getElementById('sidebar')
  const sidebarShade = document.getElementById('sidebar-shade') as HTMLElement

  if (sidebarShade) {
    sidebarShade.addEventListener('click', () => {
      toggleSidebar()
    })
  }

  function toggleSidebar() {
    if (sidebar && sidebar.classList.contains('show')) {
      sidebar.classList.remove('show')
      sidebarShade.style.display = 'none'
    } else if (sidebar) {
      sidebar.classList.add('show')
      sidebarShade.style.display = 'block'
    }
  }

  sidebarButton?.addEventListener('click', () => {
    toggleSidebar()
  })
</script>

<style>
/* Mobile TOC Drawer Styles overrides */
  @media (min-width: 1280px) {
    /* XL is the breakpoint where it becomes a normal sidebar */
    #sidebar-shade {
      display: none !important;
    }
  }
  @media (max-width: 1279px) { /* Match XL breakpoint */
    aside.show {
      display: block !important;
      opacity: 1;
    }

    @keyframes fade-in-side {
      0% {
        transform: translateX(50%);
        opacity: 0;
      }
      100% {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes fade-in {
      0% {
        opacity: 0;
      }
      100% {
        opacity: 1;
      }
    }
    aside#sidebar {
      /* Reset basic sidebar styles for drawer mode */
      position: fixed !important;
      animation: 300ms fade-in-side !important;
      animation-fill-mode: forwards;
      right: 0;
      top: 0 !important;
      height: 100vh !important;
      min-width: 40vw !important;
      max-width: 75vw !important;
      border-top-right-radius: 0 !important;
      border-bottom-right-radius: 0 !important;
      padding-top: 1.5rem !important;
      padding-bottom: 1.5rem !important;
      z-index: 50; /* Higher then everything */
    }
    #sidebar-shade {
      animation: 300ms fade-in;
    }
  }
  @media (max-width: 640px) {
    aside#sidebar {
      min-width: 55vw !important;
    }
  }
