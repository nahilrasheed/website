---
import PageLayout from '@/layouts/BaseLayout.astro'
import { getVaultTree, getUniqueVaultTagsWithCount } from '@/utils/vault'
import VaultTree from '@/components/vault/VaultTree.astro'
import { Button, Icon } from '@/components/user'

const meta = {
  title: 'Vault',
  description: 'Knowledge Base'
}

const tree = await getVaultTree()
const allTags = await getUniqueVaultTagsWithCount()
const topTags = allTags.slice(0, 4)
---

<PageLayout {meta} wide>
  <div class='mt-4 max-w-[90rem] mx-auto px-4 lg:px-0'>
    <h1 class='text-3xl font-bold mb-4 tracking-tight text-foreground'>Vault</h1>
    
    <div class='flex flex-col sm:flex-row flex-wrap items-start sm:items-center sm:justify-between gap-4 mb-8'>
      <p class='text-muted-foreground text-lg'>Welcome to my digital garden. Explore the notes below.</p>
      
      {!!topTags.length && (
        <div class='flex items-center gap-2 text-base sm:text-sm flex-wrap sm:ml-auto'>
          <Icon name='tag-2' class='size-5 text-muted-foreground' />
          {topTags.map(([tag]) => (
            <Button title={tag} href={`/tags/${tag}`} variant='pill' class='text-sm sm:text-xs' />
          ))}
        </div>
        <a aria-label='View all vault tags' href='/tags' data-astro-prefetch class='text-base sm:text-xs whitespace-nowrap'>
          View all â†’
        </a>
      )}
    </div>

    <div class='vault-grid grid gap-4 sm:grid-cols-2 lg:grid-cols-3 items-start'>
      {tree.map((node) => (
        node.children.length > 0 ? (
          <details class='vault-folder group relative border rounded-xl bg-card/60 text-card-foreground shadow-sm transition-all duration-200 hover:bg-card/80 hover:z-30 open:z-50 open:bg-card open:shadow-2xl open:rounded-b-none'>
            <summary class='flex items-center gap-2 p-4 cursor-pointer list-none transition-colors select-none'>
               <svg 
                 xmlns='http://www.w3.org/2000/svg' 
                 width='18' height='18' viewBox='0 0 24 24' 
                 fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' 
                 class='shrink-0 transition-transform duration-200 ease-out group-open:rotate-90 text-muted-foreground'
               >
                  <path d='m9 18 6-6-6-6'/>
               </svg>
               {node.slug ? (
                   <a href={`/vault/${node.slug}`} class='font-semibold text-lg decoration-dotted underline underline-offset-4 hover:decoration-solid hover:text-primary flex-1 break-words'>
                      {node.title}
                      {node.entry?.data.publish === false && <span class='text-red-500 text-sm ml-1'>(Unpublished)</span>}
                   </a>
               ) : (
                   <span class='font-semibold text-lg flex-1 break-words'>{node.title}</span>
               )}
            </summary>
            <div class='vault-content absolute top-[calc(100%-1px)] left-[-1px] right-[-1px] border-x border-b border-border bg-card rounded-b-xl shadow-xl overflow-hidden'>
                <div class='vault-inner px-4 pb-4 pt-2'>
                  <ul class='pt-2 space-y-0.5'>
                      {node.children.map((child) => (
                         <VaultTree node={child} />
                      ))}
                  </ul>
                </div>
            </div>
          </details>
        ) : (
           <a href={node.slug ? `/vault/${node.slug}` : '#'} class='block p-4 relative border rounded-xl bg-card/60 text-card-foreground shadow-sm transition-all duration-300 hover:bg-card/80 hover:z-30'>
              <span class='font-semibold text-lg pl-6 block break-words'>
                  {node.title}
                  {node.entry?.data.publish === false && <span class='text-red-500 text-sm ml-1'>(Unpublished)</span>}
              </span>
           </a>
        )
      ))}
    </div>
  </div>
</PageLayout>

<style>
  .vault-folder {
    contain: layout style;
  }

  .vault-content {
    opacity: 0;
    transform: translateY(-4px);
    transition: opacity 0.2s ease-out, transform 0.2s ease-out;
    max-height: 0;
  }

  .vault-folder[open] .vault-content {
    opacity: 1;
    transform: translateY(0);
    max-height: 1000px;
    transition: opacity 0.2s ease-out, transform 0.2s ease-out, max-height 0.3s ease-out;
  }

  .vault-inner {
    animation: slideIn 0.2s ease-out;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Prevent animation on page load */
  .vault-grid:not(.initialized) .vault-content {
    transition: none;
  }
</style>

<script>
  // Accordion behavior: close other folders when one opens
  function initializeVaultAccordion() {
    const grid = document.querySelector('.vault-grid')
    if (!grid) return

    const folders = grid.querySelectorAll('.vault-folder')
    
    // Mark as initialized to enable animations
    setTimeout(() => grid.classList.add('initialized'), 100)

    folders.forEach((folder) => {
      const summary = folder.querySelector('summary')
      if (!summary) return

      summary.addEventListener('click', () => {
        const isOpen = folder.hasAttribute('open')
        
        if (!isOpen) {
          // Close all other folders with smooth animation
          folders.forEach((otherFolder) => {
            if (otherFolder !== folder && otherFolder.hasAttribute('open')) {
              otherFolder.removeAttribute('open')
            }
          })
        }
      })
    })

    // Handle folder note links (prevent closing on link click)
    const folderLinks = grid.querySelectorAll('.vault-folder a')
    folderLinks.forEach((link) => {
      link.addEventListener('click', (e) => {
        e.stopPropagation()
      })
    })
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeVaultAccordion)
  } else {
    initializeVaultAccordion()
  }

  // Re-initialize on view transitions (Astro navigation)
  document.addEventListener('astro:page-load', initializeVaultAccordion)
</script>
